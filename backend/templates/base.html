{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Lenskart Clone{% endblock %}</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .lk-topbar {
      border-bottom: 1px solid #e5e5e5;
      font-size: 12px;
    }
    .lk-topbar a {
      color: #222;
      text-decoration: none;
      margin-right: 12px;
    }
    .lk-header {
      border-bottom: 1px solid #e5e5e5;
      background: #fff;
    }
    .lk-search {
      border: 1px solid #2b2b2b;
      border-radius: 4px;
      padding: 6px 10px;
      width: 100%;
    }
    .lk-icon-btn {
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 6px;
      padding: 6px 10px;
    }
    .lk-pill {
      border: 1px solid #111;
      border-radius: 999px;
      padding: 4px 12px;
      text-decoration: none;
      color: #111;
      font-size: 13px;
    }
    .lk-nav {
      background: #faf7f2;
      border-bottom: 1px solid #e5e5e5;
    }
    .lk-nav a {
      text-decoration: none;
      color: #1a1a1a;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    .lk-nav-item {
      padding: 10px 12px;
      position: relative;
    }
    .lk-nav-item:hover .lk-mega {
      display: block;
    }
    .lk-mega {
      display: none;
      position: absolute;
      left: 0;
      top: 100%;
      width: 100vw;
      background: #fff;
      border-top: 1px solid #e5e5e5;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      z-index: 1000;
    }
    .lk-mega-inner {
      padding: 20px 24px;
      display: grid;
      grid-template-columns: 220px repeat(4, minmax(160px, 1fr));
      gap: 20px;
      font-size: 12px;
    }
    .lk-mega h6 {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    .lk-mega ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .lk-mega li {
      padding: 4px 0;
    }
    .lk-mega a {
      font-weight: 500;
      color: #2a2a2a;
    }
    .lk-subcat {
      background: #f7f2ea;
      padding: 12px;
      border-radius: 8px;
    }
    .lk-badge {
      border: 1px solid #0aa;
      color: #0aa;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
    }
    .lk-brand-btn {
      border: 1px solid #ccc;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-left: 6px;
      text-decoration: none;
      color: #111;
    }
    .lk-modal-step {
      display: none;
    }
    .lk-modal-step.active {
      display: block;
    }
    .lk-tryon-stage {
      background: #000;
      border-radius: 16px;
      height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .lk-tryon-stage video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .lk-tryon-oval {
      width: 240px;
      height: 300px;
      border-radius: 50%;
      border: 2px dashed #3fe0c5;
      box-shadow: 0 0 0 6px rgba(63, 224, 197, 0.1);
      position: relative;
      z-index: 1;
    }
    .lk-tryon-success {
      max-width: 360px;
      margin: 0 auto;
      border: 1px solid #e6e6e6;
      border-radius: 14px;
      padding: 20px;
      text-align: center;
      background: #fff;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }
    .lk-tryon-thumb {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: #f0f0f0;
      margin: 0 auto 12px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .lk-tryon-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .lk-collection-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 8px;
    }
    .lk-collection-card {
      flex: 0 0 auto;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #eee;
      background: #fff;
    }
    .lk-collection-card img {
      display: block;
      width: 240px;
      height: auto;
    }
    .lk-top-categories {
      display: grid;
      grid-template-columns: repeat(6, minmax(150px, 1fr));
      gap: 18px;
    }
    .lk-cat-card {
      position: relative;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 16px;
      padding: 14px;
      text-align: center;
    }
    .lk-cat-card img {
      max-width: 100%;
      height: 80px;
      object-fit: contain;
    }
    .lk-cat-card span {
      display: block;
      margin-top: 8px;
      font-weight: 600;
      color: #5a5a8a;
      font-size: 14px;
    }
    .lk-cat-menu {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 100%;
      width: 220px;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      padding: 10px;
      display: none;
      z-index: 20;
    }
    .lk-cat-card:hover .lk-cat-menu {
      display: block;
    }
    .lk-cat-menu a {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      text-decoration: none;
      color: #2a2a2a;
      font-size: 13px;
      border-radius: 6px;
    }
    .lk-cat-menu a:hover {
      background: #f5f5f5;
    }
    .lk-cat-menu img {
      width: 28px;
      height: 20px;
      object-fit: contain;
    }
    .lk-cat-menu .lk-all-shapes {
      justify-content: center;
      font-weight: 600;
      border-top: 1px solid #eee;
      margin-top: 6px;
      padding-top: 8px;
    }
    .lk-shape-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(120px, 1fr));
      gap: 16px;
      text-align: center;
    }
    .lk-shape-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .lk-shape-circle {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: #f7f7f7;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .lk-shape-circle img {
      max-width: 80px;
      max-height: 60px;
      object-fit: contain;
    }
    .lk-shape-card span {
      font-weight: 600;
      color: #5a5a8a;
      font-size: 14px;
    }
    .lk-trending-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(200px, 1fr));
      gap: 16px;
    }
    .lk-trending-card {
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid #eee;
      background: #fff;
      position: relative;
    }
    .lk-trending-card video,
    .lk-trending-card img {
      width: 100%;
      height: 260px;
      object-fit: cover;
      display: block;
    }
    .lk-trending-card .lk-card-label {
      position: absolute;
      left: 12px;
      bottom: 12px;
      color: #fff;
      font-weight: 600;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
      font-size: 14px;
    }
    .lk-service-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(220px, 1fr));
      gap: 16px;
    }
    .lk-service-card {
      background: #f5f6ff;
      border-radius: 22px;
      padding: 18px;
      position: relative;
      border: 1px solid #e6e7f5;
      min-height: 260px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .lk-service-pill {
      background: #0a8a66;
      color: #fff;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }
    .lk-service-title {
      font-size: 20px;
      font-weight: 700;
      color: #2b2b5a;
      margin-top: 10px;
    }
    .lk-service-media {
      width: 100%;
      text-align: right;
    }
    .lk-service-media img {
      max-height: 150px;
      width: auto;
    }
    .lk-service-arrow {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #fff;
      border: 1px solid #e6e7f5;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #2b2b5a;
      text-decoration: none;
    }
    .lk-premium-hero {
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid #111;
      margin-bottom: 16px;
    }
    .lk-premium-hero img {
      display: block;
      width: 100%;
      height: auto;
    }
    .lk-premium-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(140px, 1fr));
      gap: 12px;
    }
    .lk-premium-card {
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      padding: 10px;
      text-align: center;
    }
    .lk-premium-card img {
      width: 100%;
      height: 120px;
      object-fit: contain;
    }
    .lk-premium-card .lk-price {
      font-weight: 700;
      font-size: 12px;
      margin: 6px 0;
    }
    .lk-premium-card .lk-view-btn {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
    }
    .lk-premium-strip {
      margin-top: 16px;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #e6e6e6;
    }
    .lk-premium-strip img {
      width: 100%;
      height: auto;
      display: block;
    }
    .lk-premium-more {
      display: grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .lk-premium-more img {
      width: 100%;
      border-radius: 14px;
      display: block;
    }
    .lk-brand-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(220px, 1fr));
      gap: 16px;
    }
    .lk-brand-card {
      position: relative;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid #e6e6e6;
    }
    .lk-brand-card img {
      width: 100%;
      display: block;
    }
    .lk-eyecheck-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(240px, 1fr));
      gap: 16px;
    }
    .lk-eyecheck-card {
      border: 1px solid #e6e6e6;
      border-radius: 18px;
      overflow: hidden;
      background: #fff;
      display: flex;
      flex-direction: column;
      text-decoration: none;
      color: inherit;
    }
    .lk-eyecheck-card img {
      width: 100%;
      display: block;
    }
    .lk-eyecheck-body {
      padding: 12px 14px 16px;
      position: relative;
    }
    .lk-eyecheck-title {
      font-weight: 700;
      color: #2b2b5a;
      margin-bottom: 4px;
    }
    .lk-eyecheck-sub {
      color: #6b6b86;
      font-size: 13px;
    }
    .lk-eyecheck-arrow {
      position: absolute;
      right: 12px;
      bottom: 12px;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: #f2f3ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #2b2b5a;
    }
    .lk-footer {
      background: #0b0a4a;
      color: #fff;
      margin-top: 40px;
    }
    .lk-footer a {
      color: #d6d8ff;
      text-decoration: none;
      font-size: 13px;
    }
    .lk-footer h6 {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .lk-footer-top {
      padding: 24px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    }
    .lk-footer-mid {
      padding: 24px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    }
    .lk-footer-bottom {
      padding: 14px 0;
      font-size: 12px;
    }
    .lk-footer p {
      color: #d6d8ff;
      font-size: 12px;
      margin-bottom: 0;
    }
    .lk-footer-links a {
      margin-right: 14px;
    }
    .lk-account {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 24px;
    }
    .lk-account-sidebar {
      background: #f7f7f7;
      border-radius: 10px;
      padding: 12px;
    }
    .lk-account-sidebar a {
      display: block;
      padding: 8px 10px;
      border-radius: 6px;
      color: #333;
      text-decoration: none;
      font-size: 13px;
    }
    .lk-account-sidebar a.active {
      background: #2aaea1;
      color: #fff;
    }
    .lk-account-card {
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      background: #fff;
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>
<body>

  {% include 'navbar.html' %}

  <div class="mt-3">
    {% block content %}{% endblock %}
  </div>

  {% include 'footer.html' %}

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  {% block extra_js %}{% endblock %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var modalEl = document.getElementById("lkTryOnModal");
      if (!modalEl) return;
      var step1 = modalEl.querySelector("[data-step='1']");
      var step2 = modalEl.querySelector("[data-step='2']");
      var takeBtn = modalEl.querySelector("[data-action='take']");
      var viewBtn = modalEl.querySelector("[data-action='view']");
      var resetBtn = modalEl.querySelectorAll("[data-action='reset']");
      var video = document.getElementById("lkTryOnVideo");
      var canvas = document.getElementById("lkTryOnCanvas");
      var thumb = document.getElementById("lkTryOnThumb");
      var stream = null;

      function showStep(step) {
        [step1, step2].forEach(function (el) {
          if (!el) return;
          el.classList.remove("active");
        });
        if (step === 1 && step1) step1.classList.add("active");
        if (step === 2 && step2) step2.classList.add("active");
      }

      function startCamera() {
        if (!video || stream) return;
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(function (mediaStream) {
            stream = mediaStream;
            video.srcObject = mediaStream;
          })
          .catch(function () {
            // If permission denied, keep placeholder state.
          });
      }

      function stopCamera() {
        if (!stream) return;
        stream.getTracks().forEach(function (track) {
          track.stop();
        });
        stream = null;
      }

      if (takeBtn && canvas && video && thumb) {
        takeBtn.addEventListener("click", function () {
          var width = video.videoWidth || 640;
          var height = video.videoHeight || 480;
          canvas.width = width;
          canvas.height = height;
          var ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0, width, height);
          var dataUrl = canvas.toDataURL("image/png");
          thumb.src = dataUrl;
          localStorage.setItem("lkTryOnPhoto", dataUrl);
          showStep(2);
        });
      }
      if (viewBtn) {
        viewBtn.addEventListener("click", function () {
          var url = new URL(window.location.origin + "/search/");
          url.searchParams.set("tryon", "1");
          window.location.href = url.toString();
        });
      }
      resetBtn.forEach(function (btn) {
        btn.addEventListener("click", function () {
          showStep(1);
        });
      });

      modalEl.addEventListener("shown.bs.modal", function () {
        showStep(1);
        startCamera();
      });
      modalEl.addEventListener("hidden.bs.modal", function () {
        showStep(1);
        stopCamera();
      });
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var url = new URL(window.location.href);
      var tryon = url.searchParams.get("tryon") === "1";
      if (tryon) {
        document.body.classList.add("lk-tryon-on");
      }
      var photo = localStorage.getItem("lkTryOnPhoto");
      if (!photo) return;
      document.querySelectorAll("[data-tryon-photo]").forEach(function (img) {
        img.src = photo;
      });
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var sendBtn = document.getElementById("lk-send-otp");
      var registerBtn = document.getElementById("lk-register-send");
      var verifyBtn = document.getElementById("lk-verify-otp");
      var step1 = document.getElementById("lk-login-step-1");
      var stepRegister = document.getElementById("lk-login-step-register");
      var step2 = document.getElementById("lk-login-step-2");
      var identifierInput = document.getElementById("lk-login-identifier");
      var registerIdentifier = document.getElementById("lk-register-identifier");
      var registerFirst = document.getElementById("lk-register-first");
      var registerLast = document.getElementById("lk-register-last");
      var otpInput = document.getElementById("lk-login-otp");
      var targetLabel = document.getElementById("lk-otp-target");
      var backBtn = document.getElementById("lk-back-login");
      var showRegister = document.getElementById("lk-show-register");
      var showRegister2 = document.getElementById("lk-show-register-2");
      var showLogin = document.getElementById("lk-show-login");
      var resendBtn = document.getElementById("lk-resend-otp");
      var currentIdentifier = "";

      function getCookie(name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length === 2) return parts.pop().split(";").shift();
        return "";
      }

      function showStep2(identifier) {
        step1.classList.add("d-none");
        if (stepRegister) stepRegister.classList.add("d-none");
        step2.classList.remove("d-none");
        currentIdentifier = identifier;
        targetLabel.textContent = "OTP sent to " + identifier;
      }

      function showStep1() {
        step2.classList.add("d-none");
        if (stepRegister) stepRegister.classList.add("d-none");
        step1.classList.remove("d-none");
      }

      function showRegisterStep() {
        step1.classList.add("d-none");
        step2.classList.add("d-none");
        if (stepRegister) stepRegister.classList.remove("d-none");
      }

      function requestOtp(payload, identifier) {
        fetch("/accounts/api/auth/request-otp/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify(payload),
        })
          .then(function (res) {
            return res.json().then(function (data) {
              return { ok: res.ok, data: data };
            });
          })
          .then(function (payload) {
            if (!payload.ok) {
              alert(payload.data.detail || "Failed to send OTP.");
              return;
            }
            showStep2(identifier);
          })
          .catch(function () {
            alert("Failed to send OTP.");
          });
      }

      if (sendBtn) {
        sendBtn.addEventListener("click", function () {
          var identifier = (identifierInput.value || "").trim();
          var whatsappOptIn = document.getElementById("lk-login-whatsapp");
          if (!identifier) return;
          requestOtp(
            {
              identifier: identifier,
              whatsapp_opt_in: whatsappOptIn ? whatsappOptIn.checked : false,
            },
            identifier
          );
        });
      }

      if (registerBtn) {
        registerBtn.addEventListener("click", function () {
          var identifier = (registerIdentifier.value || "").trim();
          var first = (registerFirst.value || "").trim();
          var last = (registerLast.value || "").trim();
          var whatsappOptIn = document.getElementById("lk-register-whatsapp");
          if (!identifier) return;
          requestOtp(
            {
              identifier: identifier,
              first_name: first,
              last_name: last,
              whatsapp_opt_in: whatsappOptIn ? whatsappOptIn.checked : false,
              is_register: true,
            },
            identifier
          );
        });
      }

      if (verifyBtn) {
        verifyBtn.addEventListener("click", function () {
          var identifier = (identifierInput.value || "").trim() || currentIdentifier;
          var code = (otpInput.value || "").trim();
          if (!identifier || !code) return;
          fetch("/accounts/api/auth/verify-otp/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ identifier: identifier, code: code }),
          })
            .then(function (res) {
              return res.json().then(function (data) {
                return { ok: res.ok, data: data };
              });
            })
            .then(function (payload) {
              if (!payload.ok) {
                alert(payload.data.detail || "Invalid OTP.");
                return;
              }
              localStorage.setItem("access_token", payload.data.access);
              localStorage.setItem("refresh_token", payload.data.refresh);
              window.location.reload();
            })
            .catch(function () {
              alert("Failed to verify OTP.");
          });
        });
      }

      if (backBtn) {
        backBtn.addEventListener("click", function () {
          showStep1();
        });
      }

      if (showRegister) {
        showRegister.addEventListener("click", function (event) {
          event.preventDefault();
          showRegisterStep();
        });
      }
      if (showRegister2) {
        showRegister2.addEventListener("click", function (event) {
          event.preventDefault();
          showRegisterStep();
        });
      }
      if (showLogin) {
        showLogin.addEventListener("click", function (event) {
          event.preventDefault();
          showStep1();
        });
      }
      if (resendBtn) {
        resendBtn.addEventListener("click", function (event) {
          event.preventDefault();
          var identifier = (identifierInput.value || "").trim() || (registerIdentifier.value || "").trim() || currentIdentifier;
          if (!identifier) return;
          requestOtp({ identifier: identifier }, identifier);
        });
      }
    });
  </script>
</body>
</html>

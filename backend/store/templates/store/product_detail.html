{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }}{% endblock %}

{% block extra_head %}
<style>
  .lk-pdp-grid {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(280px, 1fr);
    gap: 28px;
  }
  .lk-pdp-gallery {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 16px;
  }
  .lk-pdp-card {
    border: 1px solid #e6e6e6;
    border-radius: 12px;
    background: #fff;
    padding: 12px;
  }
  .lk-pdp-card img {
    width: 100%;
    height: 280px;
    object-fit: contain;
    background: #f7f7f7;
    border-radius: 10px;
  }
  .lk-pdp-summary {
    border: 1px solid #e6e6e6;
    border-radius: 12px;
    padding: 16px;
    background: #fff;
  }
  .lk-pdp-price {
    font-weight: 700;
    font-size: 20px;
  }
  .lk-pill-rating {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 999px;
    background: #f3f4ff;
    font-size: 12px;
    font-weight: 600;
  }
  .lk-tryon-card {
    border: 1px solid #d9d9d9;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  .lk-tryon-card img {
    width: 52px;
    height: 52px;
    border-radius: 6px;
    object-fit: cover;
  }
  .lk-accordion {
    border-top: 1px solid #e6e6e6;
    margin-top: 14px;
  }
  .lk-accordion details {
    border-bottom: 1px solid #e6e6e6;
    padding: 10px 0;
  }
  .lk-accordion summary {
    cursor: pointer;
    list-style: none;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .lk-accordion summary::-webkit-details-marker {
    display: none;
  }
  .lk-accordion summary:after {
    content: "›";
    transform: rotate(90deg);
    font-size: 18px;
    color: #6b6b6b;
  }
  details[open] summary:after {
    transform: rotate(-90deg);
  }
  .lk-pincode {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
  }
  .lk-pincode input {
    flex: 1;
    border: none;
    border-bottom: 1px solid #d0d0d0;
    padding: 6px 4px;
  }
  .lk-pincode-result {
    border-top: 1px solid #efefef;
    margin-top: 10px;
    padding-top: 10px;
  }
  .lk-pincode-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    font-weight: 600;
  }
  .lk-pincode-meta {
    margin-top: 6px;
    font-size: 13px;
  }
  .lk-link {
    color: #1aa59a;
    font-weight: 600;
    text-decoration: none;
  }
  @media (max-width: 992px) {
    .lk-pdp-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}

<div class="container">
  <div class="lk-pdp-grid">
    <div>
      <div class="lk-pdp-gallery">
        {% for image in product_images %}
          <div class="lk-pdp-card">
            <img src="{{ image.image.url }}" alt="{{ product.name }}">
          </div>
        {% empty %}
          <div class="lk-pdp-card">
            <div class="bg-light border rounded p-5 text-center">Image</div>
          </div>
        {% endfor %}
      </div>
    </div>
    <div class="lk-pdp-summary">
      <div class="lk-pill-rating mb-2">
        4.8 ★ 2282
      </div>
      <div class="fw-semibold">{{ product.brand.name }}</div>
      <h4 class="mb-1">{{ product.name }}</h4>
      <div class="text-muted small mb-2">Size: {{ product.get_size_display|default:"-" }}</div>
      <div class="lk-pdp-price mb-3">Rs {{ product.get_display_price }}</div>

      <a class="btn btn-info text-white w-100 mb-3" href="{% url 'cart' %}?add={{ product.slug }}">BUY NOW</a>

      <div class="lk-accordion">
        <details>
          <summary>Technical information</summary>
          <div class="small text-muted mt-2">
            <div>Frame Type: {{ product.get_frame_type_display|default:"-" }}</div>
            <div>Shape: {{ product.get_shape_display|default:"-" }}</div>
            <div>Frame Material: {{ product.frame_material|default:"-" }}</div>
            <div>Frame Size: {{ product.get_size_display|default:"-" }}</div>
            <div>Frame Color: {{ product.color|default:"-" }}</div>
          </div>
        </details>
        <details>
          <summary>Visit Nearby Store</summary>
          <div class="mt-2 d-flex gap-2 align-items-center">
            <img src="/media/products/visit_store.jpg" alt="Store" width="60" height="60">
            <div class="small">
              Please share your location to see nearby stores.<br>
              <a class="lk-link" href="#">Store Locator</a>
            </div>
          </div>
        </details>
        <details>
          <summary>Check Delivery Options</summary>
          <div class="lk-pincode" data-pincode>
            <input type="text" inputmode="numeric" maxlength="6" placeholder="Enter Pincode" aria-label="Enter Pincode">
            <button class="btn btn-link lk-link p-0" type="button" data-pincode-check>Check</button>
          </div>
          <div class="lk-pincode-error text-danger small d-none" data-pincode-error>Please enter a valid 6 digit pincode.</div>
          <div class="lk-pincode-result d-none" data-pincode-result>
            <div class="lk-pincode-row">
              <span data-pincode-value></span>
              <button class="btn btn-link lk-link p-0" type="button" data-pincode-change>Change</button>
            </div>
            <div class="lk-pincode-meta">
              <div>(Free)</div>
              <div data-pincode-date></div>
              <div class="text-muted">Delivery time not applicable for progressive and high power.</div>
            </div>
          </div>
        </details>
        <details>
          <summary>Review (2282)</summary>
          <div class="mt-2">
            <div class="text-warning">★★★★★</div>
            <div class="fw-semibold mt-1">GD Gd</div>
            <div class="small text-muted">Harshit S. - Jan 14, 2026</div>
            <button class="btn btn-outline-info btn-sm mt-2">MORE REVIEWS</button>
          </div>
        </details>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var pincodeWrap = document.querySelector("[data-pincode]");
    if (!pincodeWrap) {
      return;
    }
    var input = pincodeWrap.querySelector("input");
    var checkBtn = pincodeWrap.querySelector("[data-pincode-check]");
    var result = document.querySelector("[data-pincode-result]");
    var value = document.querySelector("[data-pincode-value]");
    var dateEl = document.querySelector("[data-pincode-date]");
    var changeBtn = document.querySelector("[data-pincode-change]");
    var error = document.querySelector("[data-pincode-error]");

    function isValidPincode(pin) {
      return /^[1-9][0-9]{5}$/.test(pin);
    }

    function addDays(days) {
      var d = new Date();
      d.setDate(d.getDate() + days);
      return d;
    }

    function formatDate(d) {
      var weekday = new Intl.DateTimeFormat("en-IN", { weekday: "short" });
      var month = new Intl.DateTimeFormat("en-IN", { month: "short" });
      var day = new Intl.DateTimeFormat("en-IN", { day: "2-digit" });
      var year = new Intl.DateTimeFormat("en-IN", { year: "numeric" });
      return weekday.format(d) + " " + month.format(d) + " " + day.format(d) + " " + year.format(d);
    }

    function setState(checked) {
      if (checked) {
        pincodeWrap.classList.add("d-none");
        result.classList.remove("d-none");
      } else {
        result.classList.add("d-none");
        pincodeWrap.classList.remove("d-none");
      }
    }

    function showError(show, message) {
      if (show) {
        if (message) {
          error.textContent = message;
        }
        error.classList.remove("d-none");
      } else {
        error.classList.add("d-none");
      }
    }

    function setResult(payload) {
      value.textContent = payload.pincode || input.value.trim();
      if (payload.delivery_date) {
        dateEl.textContent = payload.delivery_date;
      } else {
        var fallbackDays = payload.delivery_days || 3;
        dateEl.textContent = formatDate(addDays(fallbackDays));
      }
      setState(true);
    }

    function checkPincode(pin) {
      checkBtn.disabled = true;
      checkBtn.textContent = "Checking...";
      fetch("/api/pincode-check/?pincode=" + encodeURIComponent(pin), {
        headers: { "Accept": "application/json" }
      })
        .then(function (response) {
          return response.json().then(function (data) {
            return { ok: response.ok, data: data };
          });
        })
        .then(function (result) {
          if (!result.ok) {
            showError(true, result.data && result.data.error ? result.data.error : "Unable to check pincode.");
            return;
          }
          showError(false);
          setResult(result.data || {});
        })
        .catch(function () {
          showError(true, "Unable to reach the delivery service.");
        })
        .finally(function () {
          checkBtn.disabled = false;
          checkBtn.textContent = "Check";
        });
    }

    checkBtn.addEventListener("click", function () {
      var pin = input.value.trim();
      if (!isValidPincode(pin)) {
        showError(true, "Please enter a valid 6 digit pincode.");
        return;
      }
      showError(false);
      checkPincode(pin);
    });

    input.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        event.preventDefault();
        checkBtn.click();
      }
    });

    changeBtn.addEventListener("click", function () {
      setState(false);
      input.focus();
    });
  });
</script>

{% endblock %}
